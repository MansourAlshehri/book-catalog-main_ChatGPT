#!/usr/bin/env python3
"""
Log_MS (internal)
Port: 5004
Database: database3.db (logs)
Usage: python log_ms.py
"""
from flask import Flask, request, Response
import yaml, sqlite3, os, time

app = Flask("Log_MS")
DB3 = "database3.db"

def yaml_response(obj, status=200):
    return Response(yaml.safe_dump(obj), status=status, mimetype="application/x-yaml")

def init_db():
    if not os.path.exists(DB3):
        conn = sqlite3.connect(DB3)
        c = conn.cursor()
        c.execute("CREATE TABLE logs (id INTEGER PRIMARY KEY AUTOINCREMENT, service TEXT, message TEXT, ts REAL)")
        conn.commit()
        conn.close()

@app.route("/log", methods=["POST"])
def log():
    """
    Accept logs in YAML: {service: "...", message: "..."}
    Stores into DB3.
    """
    try:
        data = yaml.safe_load(request.data.decode() or "{}")
    except Exception:
        return yaml_response({"error":"invalid yaml"}, status=400)
    service = data.get("service", "unknown")
    message = data.get("message", "")
    ts = time.time()
    conn = sqlite3.connect(DB3)
    c = conn.cursor()
    c.execute("INSERT INTO logs(service, message, ts) VALUES (?,?,?)", (service, message, ts))
    conn.commit()
    conn.close()
    return yaml_response({"logged": True, "service": service, "ts": ts})

if __name__ == "__main__":
    init_db()
    print("Starting Log_MS on port 5004")
    app.run(host="0.0.0.0", port=5004)

